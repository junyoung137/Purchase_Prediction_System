# =====================================================
# ğŸ§  FastAPI ëª¨ë¸ ì„œë¹™ Dockerfile
# - Python 3.12 ê¸°ë°˜
# - non-root user ì‹¤í–‰
# - FASTAPI_PORT í™˜ê²½ë³€ìˆ˜ë¡œ í¬íŠ¸ ì œì–´
# =====================================================
FROM python:3.12-slim

# -- í™˜ê²½ ë³€ìˆ˜
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV FASTAPI_PORT=8080

# ì‘ì—… ë””ë ‰í„°ë¦¬
WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ë¹Œë“œìš© íˆ´ í¬í•¨)
RUN apt-get update \
  && apt-get install -y --no-install-recommends \
       build-essential gcc git curl ca-certificates \
  && rm -rf /var/lib/apt/lists/*

# non-root ì‚¬ìš©ì ìƒì„±
RUN useradd --create-home --shell /bin/bash appuser \
  && mkdir -p /app/models_cache \
  && chown -R appuser:appuser /app /app/models_cache

# requirements ë³µì‚¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜ (ê°€ëŠ¥í•˜ë©´ ìºì‹œ ì—†ì´)
COPY --chown=appuser:appuser requirements.txt /app/requirements.txt

# pip ì—…ê·¸ë ˆì´ë“œ ë° requirements ì„¤ì¹˜
RUN python -m pip install --upgrade pip setuptools wheel \
  && pip install --no-cache-dir -r /app/requirements.txt

# ì•± ì†ŒìŠ¤ ë³µì‚¬ (ìµœì¢…)
COPY --chown=appuser:appuser . /app

# ì‘ì—… ìœ ì € ì „í™˜
USER appuser

# ì»¨í…Œì´ë„ˆ ë…¸ì¶œ í¬íŠ¸ (ê¸°ë³¸ê°’ì€ 8080)
EXPOSE ${FASTAPI_PORT}

# ê¸°ë³¸ ì‹¤í–‰: FASTAPI_PORT í™˜ê²½ë³€ìˆ˜ì— ë§ì¶° uvicorn ì‹¤í–‰
# (docker run -e FASTAPI_PORT=5000 ... ë˜ëŠ” docker-composeë¡œ ì„¤ì •)
CMD ["sh", "-c", "uvicorn serve_model:app --host 0.0.0.0 --port ${FASTAPI_PORT} --workers 2"]
