services:
  # ======================================
  # ğŸ§  FastAPI ëª¨ë¸ ì„œë¹™ ì»¨í…Œì´ë„ˆ
  # ======================================
  fastapi:
    build: .
    container_name: fastapi-model
    restart: always
    environment:
      # âœ… MinIO (ëª¨ë¸ & Feature ì˜¤í”„ë¼ì¸ ìŠ¤í† ì–´)
      MINIO_ENDPOINT: http://minio:9000
      BUCKET: model-store
      PREFIX: session-purchase/deployed

      # âœ… Feast ì„¤ì • (Airflowì™€ ë™ì¼í•œ ê²½ë¡œ)
      FEAST_REPO_PATH: /opt/airflow/feature_repo

      # âœ… ê¸°íƒ€ ì‹¤í–‰ í™˜ê²½
      PYTHONUNBUFFERED: 1
      TZ: Asia/Seoul

    # âœ… ë‚´ë¶€ FastAPI í¬íŠ¸
    ports:
      - "9787:8080"

    volumes:
      # ëª¨ë¸ ìºì‹œ ë””ë ‰í„°ë¦¬ (FastAPI ë‚´ë¶€ì—ì„œ ëª¨ë¸ ë¡œë“œ ì‹œ ì‚¬ìš©)
      - ./models_cache:/app/models_cache
      # Feast repo ê²½ë¡œ (Airflowì˜ feature_repoì™€ ê³µìœ )
      - ../feature_repo:/opt/airflow/feature_repo

    depends_on:
      - redis

    networks:
      - spark-net     # MinIO, Spark ë“±ê³¼ í†µì‹ 
      - backend       # Streamlit, Grafana ë“± UI ê³„ì¸µ í†µì‹ 
      - mlops-net     # Redis, Feast ì˜¨ë¼ì¸ìŠ¤í† ì–´ í†µì‹ 

  # ======================================
  # âš¡ Redis (Feast Online Store / ìºì‹œìš©)
  # ======================================
  redis:
    image: redis:7.2
    container_name: redis
    restart: always
    ports:
      - "6379:6379"
    networks:
      - mlops-net

# ======================================
# ğŸŒ ë„¤íŠ¸ì›Œí¬ ì •ì˜
# ======================================
networks:
  # Spark ë° MinIO ë“± ë°ì´í„° íŒŒì´í”„ë¼ì¸ ê³„ì¸µê³¼ ì—°ê²°
  spark-net:
    external: true     # ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Spark ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©

  # Streamlit, Grafana ë“± ì‹œê°í™”/ë°±ì—”ë“œ ê³„ì¸µìš©
  backend:
    driver: bridge

  # FastAPI â†” Redis / Feast í†µì‹ ìš© MLOps ì „ìš© ë„¤íŠ¸ì›Œí¬
  mlops-net:
    driver: bridge
